name: Deploy to RunPod Serverless

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
          - development
      volume_id:
        description: 'RunPod Network Volume ID (optional - for faster startups)'
        required: false
        type: string
      gpu_type:
        description: 'GPU type for serverless workers'
        required: false
        default: 'NVIDIA A40'
        type: choice
        options:
          - NVIDIA A40
          - NVIDIA RTX A5000
          - NVIDIA RTX A4000
          - NVIDIA RTX 4090
          - NVIDIA RTX 3090
      
  push:
    branches: [main]

env:
  GAR_LOCATION: us-central1
  GAR_REPOSITORY: talking-head-registry
  PROJECT_ID: jay-dhanwant-experiments
  IMAGE_NAME: gpu-test-api

jobs:
  build-and-deploy:
    name: Build and Deploy to RunPod
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_CREDENTIALS }}
    
    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
    
    - name: Configure Docker for GAR
      run: |
        gcloud auth configure-docker ${{ env.GAR_LOCATION }}-docker.pkg.dev
    
    - name: Build and push to GAR
      run: |
        IMAGE_URL="${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.GAR_REPOSITORY }}/${{ env.IMAGE_NAME }}"
        
        # Build and tag image
        docker buildx build --platform linux/amd64 \
          -t "${IMAGE_URL}:latest" \
          -t "${IMAGE_URL}:${{ github.sha }}" \
          --push .
        
        echo "‚úÖ Built and pushed: ${IMAGE_URL}:${{ github.sha }}"
        echo "image_url=${IMAGE_URL}:${{ github.sha }}" >> $GITHUB_OUTPUT
      id: build
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        pip install requests
        echo "‚úÖ Dependencies installed"
    
    - name: Verify RunPod API
      run: |
        echo "üîë Verifying RunPod API key..."
        API_TEST=$(curl -s -H "Authorization: Bearer ${{ secrets.RUNPOD_API_KEY }}" \
          https://api.runpod.io/graphql \
          -X POST \
          -H "Content-Type: application/json" \
          -d '{"query":"{ myself { id email } }"}')
        
        echo "API Test Response: $API_TEST"
        
        if echo "$API_TEST" | jq -e '.data.myself.id' > /dev/null 2>&1; then
          echo "‚úÖ RunPod API key is valid"
        else
          echo "‚ùå RunPod API key is invalid or expired"
          exit 1
        fi
    
    - name: Deploy to RunPod Serverless
      id: deploy
      run: |
        ENDPOINT_NAME="gpu-test-${{ github.event.inputs.environment || 'production' }}"
        IMAGE_URL="${{ steps.build.outputs.image_url }}"
        
        echo "üì¶ Deploying to RunPod Serverless..."
        echo "   Endpoint: ${ENDPOINT_NAME}"
        echo "   Image: ${IMAGE_URL}"
        
        # Check if endpoint exists first (using correct GraphQL query)
        echo "üîç Checking for existing endpoints..."
        ENDPOINTS_RESPONSE=$(curl -s -X POST "https://api.runpod.io/graphql" \
          -H "Authorization: Bearer ${{ secrets.RUNPOD_API_KEY }}" \
          -H "Content-Type: application/json" \
          -d '{"query":"{ myself { endpoints { id name } } }"}')
        
        echo "Endpoints Response: $ENDPOINTS_RESPONSE"
        
        # Check if endpoint exists
        if echo "$ENDPOINTS_RESPONSE" | jq -e '.data.myself.endpoints' > /dev/null 2>&1; then
          ENDPOINT_ID=$(echo "$ENDPOINTS_RESPONSE" | jq -r ".data.myself.endpoints[] | select(.name==\"${ENDPOINT_NAME}\") | .id")
        else
          ENDPOINT_ID=""
        fi
        
        if [ -z "$ENDPOINT_ID" ]; then
          echo "üì° Creating new endpoint..."
          
          # Create template first (with all required fields)
          TEMPLATE_RESPONSE=$(curl -s -X POST "https://api.runpod.io/graphql" \
            -H "Authorization: Bearer ${{ secrets.RUNPOD_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d "{\"query\":\"mutation { saveTemplate(input: { name: \\\"${ENDPOINT_NAME}-template\\\", imageName: \\\"${IMAGE_URL}\\\", dockerArgs: \\\"\\\", containerDiskInGb: 10, volumeInGb: 0, env: [{key: \\\"CUDA_VISIBLE_DEVICES\\\", value: \\\"0\\\"}, {key: \\\"PYTHONUNBUFFERED\\\", value: \\\"1\\\"}] }) { id name } }\"}")
          
          echo "Template Response: $TEMPLATE_RESPONSE"
          TEMPLATE_ID=$(echo "$TEMPLATE_RESPONSE" | jq -r '.data.saveTemplate.id')
          
          if [ "$TEMPLATE_ID" != "null" ] && [ -n "$TEMPLATE_ID" ]; then
            echo "‚úÖ Template created with ID: ${TEMPLATE_ID}"
            
            # Create endpoint with template (reduced workers to fit quota)
            ENDPOINT_RESPONSE=$(curl -s -X POST "https://api.runpod.io/graphql" \
              -H "Authorization: Bearer ${{ secrets.RUNPOD_API_KEY }}" \
              -H "Content-Type: application/json" \
              -d "{\"query\":\"mutation { saveEndpoint(input: { name: \\\"${ENDPOINT_NAME}\\\", templateId: \\\"${TEMPLATE_ID}\\\", gpuIds: \\\"${{ github.event.inputs.gpu_type || 'NVIDIA A40' }}\\\", workersMin: 0, workersMax: 2, idleTimeout: 5, scalerType: \\\"QUEUE_DELAY\\\", scalerValue: 4 }) { id name } }\"}")
            
            echo "Endpoint Response: $ENDPOINT_RESPONSE"
            ENDPOINT_ID=$(echo "$ENDPOINT_RESPONSE" | jq -r '.data.saveEndpoint.id')
            
            if [ "$ENDPOINT_ID" != "null" ] && [ -n "$ENDPOINT_ID" ]; then
              echo "‚úÖ Endpoint created with ID: ${ENDPOINT_ID}"
            else
              echo "‚ùå Failed to create endpoint. Response: $ENDPOINT_RESPONSE"
              exit 1
            fi
          else
            echo "‚ùå Failed to create template. Response: $TEMPLATE_RESPONSE"
            exit 1
          fi
        else
          echo "üîÑ Found existing endpoint: ${ENDPOINT_ID}"
          # Update template with new image (with all required fields)
          TEMPLATE_RESPONSE=$(curl -s -X POST "https://api.runpod.io/graphql" \
            -H "Authorization: Bearer ${{ secrets.RUNPOD_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d "{\"query\":\"mutation { saveTemplate(input: { name: \\\"${ENDPOINT_NAME}-template\\\", imageName: \\\"${IMAGE_URL}\\\", dockerArgs: \\\"\\\", containerDiskInGb: 10, volumeInGb: 0, env: [{key: \\\"CUDA_VISIBLE_DEVICES\\\", value: \\\"0\\\"}, {key: \\\"PYTHONUNBUFFERED\\\", value: \\\"1\\\"}] }) { id name } }\"}")
          echo "‚úÖ Updated template for existing endpoint"
        fi
        
        if [ "$ENDPOINT_ID" = "null" ] || [ -z "$ENDPOINT_ID" ]; then
          echo "‚ùå Failed to create endpoint"
          exit 1
        fi
        
        echo "endpoint_id=${ENDPOINT_ID}" >> $GITHUB_OUTPUT
        echo "endpoint_name=${ENDPOINT_NAME}" >> $GITHUB_OUTPUT
        echo "image_url=${IMAGE_URL}" >> $GITHUB_OUTPUT
    
    - name: Wait for deployment
      run: |
        echo "‚è≥ Waiting for deployment to complete..."
        sleep 30
        echo "‚úÖ Deployment should be ready"
    
    - name: Test endpoint
      continue-on-error: true
      run: |
        ENDPOINT_ID="${{ steps.deploy.outputs.endpoint_id }}"
        
        echo "üß™ Testing endpoint..."
        
        # Test with simple GPU test request
        RESPONSE=$(curl -s -X POST "https://api.runpod.ai/v2/${ENDPOINT_ID}/runsync" \
          -H "Authorization: Bearer ${{ secrets.RUNPOD_API_KEY }}" \
          -H "Content-Type: application/json" \
          -d '{"input": {"tokens": [1, 2, 3, 4, 5]}}' || echo "Request failed")
        
        echo "Response: $RESPONSE"
        
        # Check if response contains expected GPU test fields
        if echo "$RESPONSE" | grep -q "gpu_info"; then
          echo "‚úÖ GPU Test successful - GPU info found"
          if echo "$RESPONSE" | grep -q "cuda_available.*true"; then
            echo "‚úÖ GPU is available and accessible"
          fi
        else
          echo "‚ö†Ô∏è  GPU test - response may be incomplete"
        fi
    
    - name: Generate deployment summary
      run: |
        ENDPOINT_NAME="${{ steps.deploy.outputs.endpoint_name }}"
        ENDPOINT_ID="${{ steps.deploy.outputs.endpoint_id }}"
        IMAGE_URL="${{ steps.deploy.outputs.image_url }}"
        
        cat << EOF > runpod-deployment.md
        # RunPod GPU Test Deployment Summary
        
        ## Deployment Details
        - **Endpoint Name**: ${ENDPOINT_NAME}
        - **Endpoint ID**: ${ENDPOINT_ID}
        - **Docker Image**: ${IMAGE_URL}
        - **Environment**: ${{ github.event.inputs.environment || 'production' }}
        - **Timestamp**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')
        - **Deployed By**: ${{ github.actor }}
        - **Commit**: ${{ github.sha }}
        
        ## Configuration
        - **GPU Type**: ${{ github.event.inputs.gpu_type || 'NVIDIA RTX A4000' }}
        - **Min Workers**: 0
        - **Max Workers**: 3
        - **Container Disk**: 10GB
        - **Idle Timeout**: 5 minutes
        
        ## Test API Usage
        
        ### Synchronous Request
        \`\`\`bash
        curl -X POST "https://api.runpod.ai/v2/${ENDPOINT_ID}/runsync" \\
          -H "Authorization: Bearer YOUR_RUNPOD_API_KEY" \\
          -H "Content-Type: application/json" \\
          -d '{
            "input": {
              "tokens": [1, 2, 3, 4, 5]
            }
          }'
        \`\`\`
        
        ### Asynchronous Request
        \`\`\`bash
        # Start job
        curl -X POST "https://api.runpod.ai/v2/${ENDPOINT_ID}/run" \\
          -H "Authorization: Bearer YOUR_RUNPOD_API_KEY" \\
          -H "Content-Type: application/json" \\
          -d '{"input": {"tokens": [1, 2, 3, 4, 5]}}'
        
        # Check status (replace JOB_ID with returned ID)
        curl -X GET "https://api.runpod.ai/v2/${ENDPOINT_ID}/status/JOB_ID" \\
          -H "Authorization: Bearer YOUR_RUNPOD_API_KEY"
        \`\`\`
        
        ## Expected Response
        \`\`\`json
        {
          "status": "success",
          "gpu_info": {
            "cuda_available": true,
            "device_count": 1,
            "devices": [...]
          },
          "inference_result": {
            "prediction": 0,
            "confidence": 0.5,
            "device_used": "cuda:0"
          },
          "gpu_memory": {
            "allocated_mb": 50.2,
            "reserved_mb": 100.0
          }
        }
        \`\`\`
        
        ## Monitoring
        - RunPod Dashboard: https://www.runpod.io/console/serverless
        - Endpoint Logs: https://www.runpod.io/console/serverless/${ENDPOINT_ID}/logs
        
        ## Local Testing (FastAPI)
        \`\`\`bash
        # Install dependencies
        pip install -r requirements.txt
        
        # Run locally
        python main.py
        
        # Test endpoints
        curl http://localhost:8000/health
        curl -X POST http://localhost:8000/predict \\
          -H "Content-Type: application/json" \\
          -d '{"tokens": [1, 2, 3, 4, 5]}'
        \`\`\`
        EOF
        
        cat runpod-deployment.md
    
    - name: Upload deployment artifacts
      uses: actions/upload-artifact@v4
      with:
        name: runpod-deployment-${{ github.sha }}
        path: runpod-deployment.md
        retention-days: 30
    
    - name: Update deployment status
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "## ‚úÖ RunPod GPU Test Deployment Successful!" >> $GITHUB_STEP_SUMMARY
        else
          echo "## ‚ùå RunPod GPU Test Deployment Failed!" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Deployment Information" >> $GITHUB_STEP_SUMMARY
        echo "- **Endpoint**: ${{ steps.deploy.outputs.endpoint_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Image**: ${{ steps.deploy.outputs.image_url }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Environment**: ${{ github.event.inputs.environment || 'production' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Timestamp**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY